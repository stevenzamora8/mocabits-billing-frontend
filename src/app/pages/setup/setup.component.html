<div class="setup-container">
  <!-- Header -->
  <div class="setup-header">
    <div class="header-content">
      <div class="welcome-badge">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        ¬°Bienvenido!
      </div>
      <h1>Configuremos tu sistema de facturaci√≥n</h1>
      <p>Solo necesitamos algunos datos para personalizar tu experiencia. Este proceso tomar√° solo unos minutos.</p>
    </div>
    <div class="progress-section">
      <div class="progress-indicator">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
        </div>
        <div class="progress-steps">
          <div class="progress-step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
            <span>1</span>
          </div>
          <div class="progress-step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
            <span>2</span>
          </div>
          <div class="progress-step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
            <span>3</span>
          </div>
          <div class="progress-step" [class.active]="currentStep >= 4" [class.completed]="currentStep > 4">
            <span>4</span>
          </div>
        </div>
      </div>
      <span class="progress-text">Paso {{ currentStep }} de {{ totalSteps }}</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="setup-content">
    <div class="setup-card">
      <!-- Step Header -->
      <div class="step-header">
        <div class="step-icon">
          <svg *ngIf="currentStep === 1" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
          </svg>
          <svg *ngIf="currentStep === 2" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          <svg *ngIf="currentStep === 3" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          <svg *ngIf="currentStep === 4" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="step-info">
          <h2>{{ getStepTitle() }}</h2>
          <p>{{ getStepDescription() }}</p>
          <div class="step-tips">
            <span class="tip-icon">üí°</span>
            <span *ngIf="currentStep === 1">Necesitar√°s tu RUC y datos de tu empresa a mano</span>
            <span *ngIf="currentStep === 2">Puedes configurar m√∫ltiples establecimientos si los necesitas</span>
            <span *ngIf="currentStep === 3">Tu logo aparecer√° en todas las facturas generadas</span>
            <span *ngIf="currentStep === 4">La firma electr√≥nica es requerida para facturaci√≥n v√°lida</span>
          </div>
        </div>
      </div>

      <!-- Step Content Container -->
      <div class="step-content-wrapper">

      <!-- Step 1: Datos del Contribuyente -->
      <div *ngIf="currentStep === 1" class="step-content">
        <div class="content-intro">
          <p>Informaci√≥n b√°sica de tu empresa para facturaci√≥n electr√≥nica.</p>
        </div>
        <form [formGroup]="companyForm" class="form-grid">
          <div class="form-group">
            <label for="ruc">RUC *</label>
            <input 
              type="text" 
              id="ruc" 
              formControlName="ruc" 
              placeholder="0928914464001"
              maxlength="13"
              class="setup-input"
              [ngStyle]="{
                'border': isFieldInvalid(companyForm, 'ruc') ? '2px solid #ef4444 !important' : '2px solid #d1d5db !important',
                'border-width': '2px !important',
                'border-style': 'solid !important',
                'outline': 'none !important',
                'background-color': isFieldInvalid(companyForm, 'ruc') ? '#fef2f2 !important' : '#ffffff !important'
              }"
              style="border: 2px solid #d1d5db !important; outline: none !important;"
              [class.error]="isFieldInvalid(companyForm, 'ruc')"
              [style.border]="isFieldInvalid(companyForm, 'ruc') ? '2px solid #ef4444 !important' : '2px solid #d1d5db !important'"
              (focus)="onInputFocusTemplate($event)"
              (blur)="onInputBlurTemplate($event)">
            <small *ngIf="!isFieldInvalid(companyForm, 'ruc')">13 d√≠gitos</small>
            <div *ngIf="isFieldInvalid(companyForm, 'ruc')" class="error-message">
              {{ getFieldError(companyForm, 'ruc') }}
            </div>
          </div>

          <div class="form-group">
            <label for="codDoc">C√≥digo de Documento *</label>
            <select id="codDoc" formControlName="codDoc" class="setup-input">
              <option value="04">04 - RUC</option>
              <option value="05">05 - C√©dula</option>
            </select>
          </div>

          <div class="form-group full-width">
            <label for="razonSocial">Raz√≥n Social *</label>
            <input 
              type="text" 
              id="razonSocial" 
              formControlName="razonSocial" 
              placeholder="Distribuidora de Suministros Nacional S.A."
              class="setup-input"
              [class.error]="isFieldInvalid(companyForm, 'razonSocial')">
            <div *ngIf="isFieldInvalid(companyForm, 'razonSocial')" class="error-message">
              {{ getFieldError(companyForm, 'razonSocial') }}
            </div>
          </div>

          <div class="form-group full-width">
            <label for="nombreComercial">Nombre Comercial *</label>
            <input 
              type="text" 
              id="nombreComercial" 
              formControlName="nombreComercial" 
              placeholder="Empresa Importadora y Exportadora de Piezas"
              class="setup-input"
              [class.error]="isFieldInvalid(companyForm, 'nombreComercial')">
            <div *ngIf="isFieldInvalid(companyForm, 'nombreComercial')" class="error-message">
              {{ getFieldError(companyForm, 'nombreComercial') }}
            </div>
          </div>

          <div class="form-group full-width">
            <label for="dirMatriz">Direcci√≥n Matriz *</label>
            <textarea 
              id="dirMatriz" 
              formControlName="dirMatriz" 
              placeholder="Enrique Guerrero Portilla OE1-34 AV. Galo Plaza Lasso"
              rows="2"
              class="setup-input"
              [class.error]="isFieldInvalid(companyForm, 'dirMatriz')"></textarea>
            <div *ngIf="isFieldInvalid(companyForm, 'dirMatriz')" class="error-message">
              {{ getFieldError(companyForm, 'dirMatriz') }}
            </div>
          </div>

          <div class="form-group">
            <label for="obligadoContabilidad">Obligado a llevar contabilidad *</label>
            <select id="obligadoContabilidad" formControlName="obligadoContabilidad" class="setup-input">
              <option value="SI">SI</option>
              <option value="NO">NO</option>
            </select>
          </div>
        </form>
      </div>

      <!-- Step 2: Establecimientos -->
      <div *ngIf="currentStep === 2" class="step-content">
        <div class="content-intro">
          <p>Configura tus puntos de emisi√≥n de facturas. Puedes tener m√∫ltiples establecimientos.</p>
        </div>
        
        <!-- Tabs de establecimientos -->
        <div class="establishments-tabs" *ngIf="establishments.length > 1">
          <div class="tabs-header">
            <button 
              *ngFor="let establishment of establishments; let i = index"
              type="button"
              class="tab-button"
              [class.active]="currentEstablishmentIndex === i"
              (click)="selectEstablishment(i)">
              Establecimiento {{ establishment.estab }}
              <span 
                *ngIf="establishments.length > 1" 
                class="remove-tab"
                (click)="$event.stopPropagation(); removeEstablishment(i)"
                title="Eliminar establecimiento">
                √ó
              </span>
            </button>
            <button 
              type="button" 
              class="add-tab-button"
              (click)="addNewEstablishment()"
              title="Agregar establecimiento">
              +
            </button>
          </div>
        </div>

        <!-- Establecimiento actual -->
        <div class="establishment-info" *ngIf="establishments.length === 1">
          <div class="establishment-header">
            <h3>Establecimiento Principal</h3>
            <button 
              type="button" 
              class="btn btn-outline btn-sm"
              (click)="addNewEstablishment()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 5v14m7-7H5"/>
              </svg>
              Agregar Otro Establecimiento
            </button>
          </div>
        </div>

        <form [formGroup]="establishmentForm" class="form-grid">
          <div class="form-group">
            <label for="estab">C√≥digo del Establecimiento *</label>
            <input 
              type="text" 
              id="estab" 
              formControlName="estab" 
              placeholder="001"
              maxlength="3"
              class="setup-input"
              [class.error]="isFieldInvalid(establishmentForm, 'estab')">
            <small>3 d√≠gitos</small>
            <div *ngIf="isFieldInvalid(establishmentForm, 'estab')" class="error-message">
              {{ getFieldError(establishmentForm, 'estab') }}
            </div>
          </div>

          <div class="form-group">
            <label for="ptoEmi">Punto de Emisi√≥n *</label>
            <input 
              type="text" 
              id="ptoEmi" 
              formControlName="ptoEmi" 
              placeholder="001"
              maxlength="3"
              class="setup-input"
              [class.error]="isFieldInvalid(establishmentForm, 'ptoEmi')">
            <small>3 d√≠gitos</small>
            <div *ngIf="isFieldInvalid(establishmentForm, 'ptoEmi')" class="error-message">
              {{ getFieldError(establishmentForm, 'ptoEmi') }}
            </div>
          </div>

          <div class="form-group">
            <label for="secuencial">Secuencial Inicial *</label>
            <input 
              type="text" 
              id="secuencial" 
              formControlName="secuencial" 
              placeholder="000000001"
              maxlength="9"
              class="setup-input"
              [class.error]="isFieldInvalid(establishmentForm, 'secuencial')">
            <small>9 d√≠gitos</small>
            <div *ngIf="isFieldInvalid(establishmentForm, 'secuencial')" class="error-message">
              {{ getFieldError(establishmentForm, 'secuencial') }}
            </div>
          </div>

          <div class="form-group full-width">
            <label for="dirEstablecimiento">Direcci√≥n del Establecimiento *</label>
            <textarea 
              id="dirEstablecimiento" 
              formControlName="dirEstablecimiento" 
              placeholder="Sebasti√°n Moreno S/N Francisco Garc√≠a"
              rows="2"
              class="setup-input"
              [class.error]="isFieldInvalid(establishmentForm, 'dirEstablecimiento')"></textarea>
            <div *ngIf="isFieldInvalid(establishmentForm, 'dirEstablecimiento')" class="error-message">
              {{ getFieldError(establishmentForm, 'dirEstablecimiento') }}
            </div>
          </div>
        </form>

        <!-- Resumen de establecimientos configurados -->
        <div class="establishments-summary" *ngIf="establishments.length > 1">
          <h4>Resumen de Establecimientos ({{ establishments.length }})</h4>
          <div class="summary-grid">
            <div 
              *ngFor="let est of establishments; let i = index" 
              class="summary-item"
              [class.current]="currentEstablishmentIndex === i">
              <div class="summary-header">
                <strong>{{ est.estab }}-{{ est.ptoEmi }}</strong>
                <button 
                  type="button" 
                  class="btn-icon"
                  (click)="selectEstablishment(i)"
                  title="Editar">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
              </div>
              <p class="summary-address">{{ est.dirEstablecimiento || 'Sin direcci√≥n' }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Logo -->
      <div *ngIf="currentStep === 3" class="step-content">
        <div class="upload-section">
          <div class="upload-area" [class.has-file]="logoFile">
            <input 
              type="file" 
              id="logo" 
              (change)="onLogoChange($event)" 
              accept="image/*" 
              class="file-input">
            <label for="logo" class="upload-label">
              <div class="upload-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8s0 0 0 0l-6-6s0 0 0 0z"/>
                  <path d="M14 2v6h6"/>
                  <path d="M16 13H8"/>
                  <path d="M16 17H8"/>
                  <path d="M10 9H8"/>
                </svg>
              </div>
              <div class="upload-text">
                <h3>{{ logoFile ? logoFile.name : 'Subir Logo' }}</h3>
                <p>{{ logoFile ? 'Archivo seleccionado' : 'Arrastra un archivo aqu√≠ o haz clic para seleccionar' }}</p>
                <small>PNG, JPG, GIF hasta 5MB</small>
              </div>
            </label>
          </div>
          
          <div class="upload-requirements">
            <h4>Requisitos del logo:</h4>
            <ul>
              <li>Formato: PNG, JPG o GIF</li>
              <li>Tama√±o m√°ximo: 5MB</li>
              <li>Dimensiones recomendadas: 300x300px</li>
              <li>Fondo transparente (recomendado)</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Step 4: Firma Electr√≥nica -->
      <div *ngIf="currentStep === 4" class="step-content">
        <div class="upload-section">
          <div class="upload-area" [class.has-file]="signatureFile" [class.has-error]="getSignatureError()">
            <input 
              type="file" 
              id="signature" 
              (change)="onSignatureChange($event)" 
              accept=".p12,.pfx" 
              class="file-input">
            <label for="signature" class="upload-label">
              <div class="upload-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M6 2a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6H6z"/>
                  <path d="M14 2v6h6"/>
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                  <path d="M6 18v-1a2 2 0 012-2h4a2 2 0 012 2v1"/>
                </svg>
              </div>
              <div class="upload-text">
                <h3>{{ signatureFile ? signatureFile.name : 'Subir Certificado' }}</h3>
                <p *ngIf="!signatureFile && !getSignatureError()">Arrastra tu certificado .p12 aqu√≠ o haz clic para seleccionar</p>
                <p *ngIf="signatureFile && !getSignatureError()" class="success-text">‚úì Certificado v√°lido seleccionado</p>
                <p *ngIf="getSignatureError()" class="error-text">{{ getSignatureError() }}</p>
                <small>Archivo .p12 o .pfx (m√°ximo 5MB)</small>
              </div>
            </label>
          </div>
          
          <!-- Mensaje de error detallado -->
          <div *ngIf="getSignatureError()" class="validation-error">
            <div class="error-content">
              <p>{{ getSignatureError() }}</p>
              <ul class="error-suggestions">
                <li>Verifica que el archivo sea un certificado digital v√°lido (.p12 o .pfx)</li>
                <li>Aseg√∫rate de que el archivo no est√© corrupto</li>
                <li>El certificado debe estar vigente y emitido por una autoridad certificadora</li>
                <li>El tama√±o del archivo no debe exceder 5MB</li>
              </ul>
            </div>
          </div>

          <!-- Estado de validaci√≥n exitosa -->
          <div *ngIf="signatureFile && !getSignatureError()" class="validation-success">
            <div class="success-content">
              <p>El archivo {{ signatureFile.name }} ha sido validado correctamente.</p>
              <div class="file-details">
                <span class="detail-item">Tama√±o: {{ formatFileSize(signatureFile.size) }}</span>
                <span class="detail-item">Tipo: Certificado PKCS#12</span>
              </div>
            </div>
          </div>
          
          <div class="upload-requirements">
            <h4>Sobre el certificado de firma electr√≥nica:</h4>
            <ul>
              <li>Debe ser un archivo .p12 o .pfx v√°lido</li>
              <li>Emitido por una autoridad certificadora autorizada (UANATACA, ECLIPSOFT, etc.)</li>
              <li>Debe estar vigente y no expirado</li>
              <li>Necesario para firmar facturas electr√≥nicas seg√∫n la normativa del SRI</li>
              <li>El archivo ser√° validado autom√°ticamente al seleccionarlo</li>
            </ul>
          </div>
        </div>
      </div>

      </div>
      <!-- End Step Content Wrapper -->

      <!-- Navigation Buttons -->
      <div class="step-navigation">
        <button 
          *ngIf="currentStep > 1" 
          type="button" 
          class="btn btn-secondary" 
          (click)="prevStep()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
          Anterior
        </button>

        <div class="nav-spacer"></div>

        <button 
          *ngIf="currentStep < totalSteps" 
          type="button" 
          class="btn btn-primary" 
          [disabled]="!canContinue()"
          (click)="nextStep()">
          <span *ngIf="!isLoading">Siguiente</span>
          <span *ngIf="isLoading">Procesando...</span>
          <svg *ngIf="!isLoading" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>

        <button 
          *ngIf="currentStep === totalSteps" 
          type="button" 
          class="btn btn-success" 
          [disabled]="!canFinish()"
          (click)="finishSetup()">
          <span *ngIf="!isLoading">Finalizar Configuraci√≥n</span>
          <span *ngIf="isLoading">Guardando...</span>
          <svg *ngIf="!isLoading" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
          <div *ngIf="isLoading" class="loading-spinner"></div>
        </button>
      </div>
    </div>
  </div>
</div>
