<div class="dashboard-layout">
  <!-- Sidebar Overlay (para móviles/tablets) -->
  <div class="sidebar-overlay" 
       *ngIf="!isSidebarCollapsed && isMobileOrTablet" 
       (click)="toggleSidebar()">
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" [class.collapsed]="isSidebarCollapsed">
    <!-- Logo & Brand -->
    <div class="sidebar-header">
      <div class="brand-logo">
        <!-- Use the same small logo used on the auth/login pages -->
        <div class="brand-logo-small">
          <i class="fas fa-cube" style="color: var(--logo-primary-color); font-size: 1.6rem;"></i>
        </div>
      </div>
      <div class="brand-text" *ngIf="!isSidebarCollapsed">
        <h3>MocaBits</h3>
        <span>Sistema de Facturación</span>
      </div>
    </div>


    <!-- Navigation (exactly like the attached template) -->
    <nav class="sidebar-menu">
      <div class="menu-section">
        <div class="menu-title">Principal</div>
  <a class="menu-item" title="Dashboard" (click)="navigateTo('/dashboard'); $event.preventDefault()" [class.active]="isActive('/dashboard')">
          <i class="fas fa-home"></i>
          <span *ngIf="!isSidebarCollapsed">Dashboard</span>
        </a>
  <a class="menu-item" title="Facturas" (click)="navigateTo('/dashboard/invoices'); $event.preventDefault()" [class.active]="isActive('/dashboard/invoices')">
          <i class="fas fa-file-invoice"></i>
          <span *ngIf="!isSidebarCollapsed">Facturas</span>
          <span class="menu-badge" *ngIf="!isSidebarCollapsed">{{ invoiceBadgeCount }}</span>
        </a>
  <a class="menu-item" title="Comprobantes" (click)="navigateTo('/dashboard/receipts'); $event.preventDefault()">
          <i class="fas fa-receipt"></i>
          <span *ngIf="!isSidebarCollapsed">Comprobantes</span>
        </a>
  
      </div>

      <div class="menu-section">
        <div class="menu-title">Gestión</div>
  <a class="menu-item" title="Productos" (click)="navigateTo('/dashboard/products'); $event.preventDefault()" [class.active]="isActive('/dashboard/products')">
          <i class="fas fa-box"></i>
          <span *ngIf="!isSidebarCollapsed">Productos</span>
        </a>
  <a class="menu-item" title="Clientes" (click)="navigateTo('/dashboard/clients'); $event.preventDefault()" [class.active]="isActive('/dashboard/clients')">
          <i class="fas fa-users"></i>
          <span *ngIf="!isSidebarCollapsed">Clientes</span>
        </a>
  <a class="menu-item" title="Establecimientos" (click)="navigateTo('/dashboard/locations'); $event.preventDefault()">
          <i class="fas fa-store"></i>
          <span *ngIf="!isSidebarCollapsed">Establecimientos</span>
        </a>
  <a class="menu-item" title="SRI" (click)="navigateTo('/dashboard/sri'); $event.preventDefault()">
          <i class="fas fa-file-alt"></i>
          <span *ngIf="!isSidebarCollapsed">SRI</span>
        </a>
      </div>

      <div class="menu-section">
        <div class="menu-title">Reportes</div>
  <a class="menu-item" title="Estadísticas" (click)="navigateTo('/dashboard/stats'); $event.preventDefault()">
          <i class="fas fa-chart-bar"></i>
          <span *ngIf="!isSidebarCollapsed">Estadísticas</span>
        </a>
  <a class="menu-item" title="Exportar" (click)="navigateTo('/dashboard/export'); $event.preventDefault()">
          <i class="fas fa-file-export"></i>
          <span *ngIf="!isSidebarCollapsed">Exportar</span>
        </a>
      </div>

      <div class="menu-section">
        <div class="menu-title">Sistema</div>
  <a class="menu-item" title="Configuración" (click)="navigateTo('/dashboard/settings'); $event.preventDefault()" [class.active]="isActive('/dashboard/settings')">
          <i class="fas fa-cog"></i>
          <span *ngIf="!isSidebarCollapsed">Configuración</span>
        </a>
  <a class="menu-item" title="Ayuda" (click)="navigateTo('/dashboard/help'); $event.preventDefault()">
          <i class="fas fa-question-circle"></i>
          <span *ngIf="!isSidebarCollapsed">Ayuda</span>
        </a>
      </div>
    </nav>

    <!-- User Info (match template: sidebar user + dropdown) -->
        <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="user-dropdown">
          <a href="#" class="user-dropdown-item" title="Perfil" (click)="navigateTo('/dashboard/company')">
            <i class="fas fa-user"></i>
            <span>Perfil</span>
          </a>
          <a href="#" class="user-dropdown-item" title="Configuración" (click)="navigateTo('/dashboard/settings')">
            <i class="fas fa-cog"></i>
            <span>Configuración</span>
          </a>
          <a href="#" class="user-dropdown-item" title="Ayuda" (click)="navigateTo('/dashboard/help')">
            <i class="fas fa-question-circle"></i>
            <span>Ayuda</span>
          </a>
          <div class="user-dropdown-divider"></div>
          <a href="#" class="user-dropdown-item danger" title="Cerrar sesión" (click)="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Cerrar Sesión</span>
          </a>
        </div>

        <div class="user-avatar" title="{{ userName }}">{{ userInitials }}</div>
        <div class="user-details" *ngIf="!isSidebarCollapsed">
          <div class="user-name">{{ userName }}</div>
          <div class="user-role-small">{{ userRole }}</div>
        </div>
        <i class="fas fa-chevron-down ms-auto" *ngIf="!isSidebarCollapsed"></i>
      </div>
    </div>
  </aside>

  <!-- Top Header (template v2) -->
  <main class="main-content">
    <header class="top-header">
      <div class="header-left">
        <div class="header-top-row">
          <button class="sidebar-toggle" (click)="toggleSidebar()" aria-label="Minimizar sidebar">
            <i class="fas" [ngClass]="isSidebarCollapsed ? 'fa-angle-right' : 'fa-angle-left'"></i>
          </button>

          <div class="breadcrumb-nav" *ngIf="breadcrumbs.length">
            <ng-container *ngFor="let b of breadcrumbs; let i = index; let last = last">
              <ng-container *ngIf="i === 0">
                <a [routerLink]="b.path"><i class="fas fa-home"></i> {{ b.label }}</a>
              </ng-container>

              <ng-container *ngIf="i > 0 && !last">
                <span class="separator">/</span>
                <a [routerLink]="b.path">{{ b.label }}</a>
              </ng-container>

              <ng-container *ngIf="last && i > 0">
                <span class="separator">/</span>
                <span class="current">{{ b.label || 'Resumen' }}</span>
              </ng-container>
            </ng-container>
          </div>

          <!-- Compact client info when a client is selected elsewhere in the app -->
          <div class="header-client-info" *ngIf="headerActiveClient">
            <div class="client-name">{{ headerActiveClient?.name }}</div>
            <div class="client-meta">{{ headerActiveClient?.identification }} • {{ headerActiveClient?.typeIdentification }}</div>
          </div>

          <!-- Avoid duplicating the page title when breadcrumbs already show the current page. Show H1 only on dashboard root (no additional breadcrumbs). -->
          <h1 *ngIf="!breadcrumbs || breadcrumbs.length <= 1">{{ (breadcrumbs && breadcrumbs.length > 1) ? (breadcrumbs[1].label || 'Panel de Control') : (breadcrumbs && breadcrumbs.length ? (breadcrumbs[breadcrumbs.length-1].label || 'Panel de Control') : 'Panel de Control') }}</h1>
        </div>
      </div>
      <div class="header-right">
        <div class="header-icon" title="Notificaciones">
          <i class="fas fa-bell"></i>
          <span class="badge">{{ notificationCount }}</span>
        </div>
        <div class="header-icon" title="Ajustes Rápidos">
          <i class="fas fa-cog"></i>
        </div>

        <!-- Header User -->
        <div class="header-user user-profile-btn" (click)="toggleUserModal($event)">
          <div class="header-user-dropdown" *ngIf="isUserModalOpen">
            <a href="#" class="header-user-dropdown-item" (click)="navigateTo('/dashboard/company'); $event.preventDefault()">
              <i class="fas fa-user"></i>
              <span>Perfil</span>
            </a>
            <a href="#" class="header-user-dropdown-item" (click)="navigateTo('/dashboard/settings'); $event.preventDefault()">
              <i class="fas fa-cog"></i>
              <span>Configuración</span>
            </a>
            <a href="#" class="header-user-dropdown-item" (click)="navigateTo('/dashboard/help'); $event.preventDefault()">
              <i class="fas fa-question-circle"></i>
              <span>Ayuda</span>
            </a>
            <div class="header-user-dropdown-divider"></div>
            <a href="#" class="header-user-dropdown-item danger" (click)="logout(); $event.preventDefault()">
              <i class="fas fa-sign-out-alt"></i>
              <span>Cerrar Sesión</span>
            </a>
          </div>

          <div class="header-user-avatar">{{ userInitials }}</div>
          <div class="header-user-info">
            <h4>{{ userName }}</h4>
            <p>{{ userRole }}</p>
          </div>
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
    </header>

      <!-- Page Content -->
      <!-- Render child routes (home, clients, invoices, etc.) -->
      <div class="content-area">
        <router-outlet></router-outlet>
      </div>
    </main>
</div>

