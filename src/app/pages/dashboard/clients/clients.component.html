<div class="clients-container">
  <!-- Toast (ui-alert) for regular notifications -->
  <ui-alert
    *ngIf="alertVisible && !alertConfirmMode"
    [message]="alertMessage"
    [type]="alertType"
    [dismissible]="!alertConfirmMode"
    [autoDismiss]="alertAutoDismiss"
    [duration]="alertAutoDismiss ? 2200 : 0"
    (closed)="handleAlertClosed()"
  ></ui-alert>

  <!-- Old confirmation modal (disabled - using new UiConfirm instead) -->

  <!-- New UI Confirm component (toast-style confirmation) -->
  <ui-confirm
    *ngIf="confirmVisible"
    [message]="confirmMessage"
    [title]="confirmTitle"
    [type]="confirmType"
    [confirmText]="getConfirmText()"
    [cancelText]="'Cancelar'"
    (confirmed)="handleUiConfirmConfirmed()"
    (cancelled)="handleUiConfirmCancelled()"
    (closed)="handleUiConfirmClosed()"
  ></ui-confirm>
  <!-- Top actions (moved into the card header below) -->

  <!-- Short description explaining the purpose of this component (styled) -->
  <!-- Reusable page intro component; action button projected via template -->
  <ng-template #introAction>
    <app-button variant="primary" size="md" [routerLink]="['/dashboard','clients','create']">
      <span class="app-button__icon-html"><i class="fas fa-plus"></i></span>
      Nuevo Cliente
    </app-button>
  </ng-template>

  <!-- Reusable page intro component (projects the introAction template) -->
  <ui-page-intro
    [title]="'Gestión de clientes'"
    [description]="'Busca, filtra y administra clientes. Crea, ve, edita, activa/inactiva y elimina clientes desde esta pantalla.'"
    [iconClass]="'fas fa-users'"
    [actionTemplate]="introAction">
  </ui-page-intro>

  <div class="stats-grid" style="margin-top:1.25rem;margin-bottom:1.5rem">
    <div class="stat-card primary">
      <div class="stat-icon primary">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ totalClients }}</div>
        <div class="stat-label">Total Clientes</div>
      </div>
    </div>

    <div class="stat-card success">
      <div class="stat-icon success">
        <i class="fas fa-user-check"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ activeClients }}</div>
        <div class="stat-label">Clientes Activos</div>
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon warning">
        <i class="fas fa-user-slash"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ inactiveClients }}</div>
        <div class="stat-label">Clientes Inactivos</div>
      </div>
    </div>
  </div>

  <!-- Filters and Search Section -->
  <div class="filters-section">
    <div class="filter-selects">
      <div class="filter-field">
        <label class="filter-label">Nombre</label>
        <div class="filter-field-row">
          <app-input
            type="text"
            placeholder="Buscar por nombre..."
            [(ngModel)]="searchTerm"
            (input)="onFilterChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-user"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field">
        <!-- Group: Tipo ID + Identificación together -->
        <div class="filter-field-row">
          <div style="flex:1 1 50%; min-width:0; display:flex; flex-direction:column; gap:0.375rem;">
            <label class="filter-label">Tipo ID</label>
            <app-select
              placeholder="Todos los tipos"
              [options]="typeOptions"
              [(ngModel)]="selectedType"
              (selectionChange)="onFilterChange()"
              rightIcon="true">
              <i slot="right-icon" class="fas fa-id-card"></i>
            </app-select>
          </div>

          <div style="flex:1 1 50%; min-width:0; display:flex; flex-direction:column; gap:0.375rem;">
            <label class="filter-label">Identificación</label>
            <app-input
              type="text"
              placeholder="Identificación..."
              [(ngModel)]="selectedIdentification"
              (input)="onFilterChange()"
              rightIcon="true">
              <i slot="right-icon" class="fas fa-hashtag"></i>
            </app-input>
          </div>
        </div>
      </div>

      <div class="filter-field">
        <label class="filter-label">Estado</label>
        <div class="filter-field-row">
          <app-select
            placeholder="Todos los estados"
            [options]="statusOptions"
            [(ngModel)]="selectedStatus"
            (selectionChange)="onFilterChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-flag"></i>
          </app-select>
        </div>
      </div>

      <!-- Clear filters button aligned with inputs: include a hidden label to keep baseline alignment -->
      <div class="filter-field filter-field-button">
        <label class="filter-label" aria-hidden="true" style="visibility:hidden">Limpiar</label>
        <div class="filter-field-row">
          <app-button
            variant="outline"
            size="md"
            (click)="clearFilters()"
            title="Limpiar todos los filtros"
            class="clear-filters-btn">
            <span class="app-button__icon-html"><i class="fas fa-broom"></i></span>
            Limpiar
          </app-button>
        </div>
      </div>
    </div>
    <div class="filter-buttons">
      <!-- filter inputs area (buttons moved to separate action-controls) -->
    </div>
  </div>

  <!-- action-controls moved above inputs inside .filters-section -->

  <!-- Clients Table -->
  <div class="clients-section">

    <!-- Card header kept minimal (buttons moved to filters) -->

    <div class="table-container">
      <!-- Table view (uses shared ui-table). Render table when loading OR when we have elements so the table's built-in skeleton shows while loading -->
      <div class="table-wrapper" *ngIf="isLoading || totalElements > 0">
          <ng-template #actions let-client>
            <div class="action-buttons">
              <app-button variant="ghost" size="sm" (click)="viewClient(client)" ariaLabel="Ver cliente" class="view-btn" title="Ver cliente">
                <span class="app-button__icon-html" aria-hidden="true"><i class="fas fa-eye"></i></span>
              </app-button>

              <app-button variant="ghost" size="sm" (click)="editClient(client)" ariaLabel="Editar cliente" class="edit-btn" title="Editar cliente">
                <span class="app-button__icon-html" aria-hidden="true"><i class="fas fa-edit"></i></span>
              </app-button>

              <app-button
                variant="ghost"
                size="sm"
                (click)="toggleClientStatus(client)"
                [attr.title]="client.status === 'A' ? 'Inactivar cliente' : 'Activar cliente'"
                [disabled]="loadingClients.has(client.id)"
                [ngClass]="{ 'activate-btn': client.status !== 'A', 'deactivate-btn': client.status === 'A' }">
                <span class="app-button__icon-html">
                  <i class="fas" [ngClass]="client.status === 'A' ? 'fa-user-times' : 'fa-user-check'"></i>
                </span>
              </app-button>

              <app-button variant="ghost" size="sm" (click)="deleteClient(client)" ariaLabel="Eliminar cliente" class="delete-btn" title="Eliminar cliente">
                <span class="app-button__icon-html" aria-hidden="true"><i class="fas fa-trash"></i></span>
              </app-button>
            </div>
          </ng-template>        <ui-table
          [columns]="[
            { field: 'name', label: 'Nombre Cliente', width: '200px' },
            { field: 'typeIdentification', label: 'Tipo ID', width: '60px' },
            { field: 'identification', label: 'Identificación', width: '140px' },
            { field: 'email', label: 'Correo', width: '220px' },
            { field: 'phone', label: 'Teléfono', width: '120px' },
            { field: 'status', label: 'Estado', width: '120px', align: 'center' }
          ]"
          [data]="paginatedClients"
          [loading]="isLoading"
          emptyText="No se encontraron clientes"
          [actionsTemplate]="actions"
          >
        </ui-table>
      </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && totalElements === 0" class="empty-state">
      <div class="empty-icon" aria-hidden="true"><i class="fas fa-users"></i></div>
      <h3>No se encontraron clientes</h3>
      <p>Intenta ajustar los filtros de búsqueda o crea un nuevo cliente.</p>
    </div>
  </div>
  </div>

  <!-- Pagination (shared ui-paginator) -->
  <ui-paginator
    [totalElements]="totalElements"
    [itemsPerPage]="itemsPerPage"
    [currentPage]="currentPage"
    (pageChange)="loadClients($event)">
  </ui-paginator>
</div>

