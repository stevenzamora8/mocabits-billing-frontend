<!-- Invoices Create Component -->
<div class="invoices-create-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1>Crear Nueva Factura</h1>
        <p>Complete los detalles de la factura</p>
      </div>
      <div class="header-actions">
        <button class="btn-secondary" (click)="cancel()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0L4.71 11.3c-.39.39-.39 1.02 0 1.41L11.3 19.3c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"/>
          </svg>
          Volver
        </button>
      </div>
    </div>
  </div>

  <!-- Invoice Form -->
  <div class="invoice-form-container">
    <form class="invoice-form">
      <!-- Client Information -->
      <div class="form-section">
        <h3>Información del Cliente</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="clientSelect">Cliente *</label>
            <select
              id="clientSelect"
              class="form-select"
              [(ngModel)]="invoiceForm.clientId"
              (change)="onClientChange()"
              name="clientId"
              required>
              <option value="">Seleccionar cliente...</option>
              <option *ngFor="let client of clients" [value]="client.id">
                {{ client.name }} ({{ client.identification }})
              </option>
            </select>
          </div>
        </div>

        <div *ngIf="invoiceForm.client" class="client-info-card">
          <div class="client-details">
            <h4>{{ invoiceForm.client.name }}</h4>
            <p><strong>ID:</strong> {{ invoiceForm.client.identification }}</p>
            <p><strong>Email:</strong> {{ invoiceForm.client.email }}</p>
            <p><strong>Teléfono:</strong> {{ invoiceForm.client.phone }}</p>
          </div>
        </div>
      </div>

      <!-- Invoice Details -->
      <div class="form-section">
        <h3>Detalles de la Factura</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="issueDate">Fecha de Emisión *</label>
            <input
              id="issueDate"
              type="date"
              class="form-input"
              [(ngModel)]="invoiceForm.issueDate"
              name="issueDate"
              required>
          </div>
          <div class="form-group">
            <label for="dueDate">Fecha de Vencimiento *</label>
            <input
              id="dueDate"
              type="date"
              class="form-input"
              [(ngModel)]="invoiceForm.dueDate"
              name="dueDate"
              required>
          </div>
          <div class="form-group">
            <label for="status">Estado</label>
            <select
              id="status"
              class="form-select"
              [(ngModel)]="invoiceForm.status"
              name="status">
              <option value="draft">Borrador</option>
              <option value="sent">Enviada</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Products Section -->
      <div class="form-section">
        <h3>Productos y Servicios</h3>

        <!-- Add Product Form -->
        <div class="add-product-section">
          <div class="form-row">
            <div class="form-group">
              <label for="productSelect">Producto</label>
              <select
                id="productSelect"
                class="form-select"
                [(ngModel)]="selectedProductId"
                name="selectedProductId">
                <option value="">Seleccionar producto...</option>
                <option *ngFor="let product of products" [value]="product.id">
                  {{ product.name }} - {{ formatCurrency(product.unitPrice) }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="quantity">Cantidad</label>
              <input
                id="quantity"
                type="number"
                class="form-input"
                [(ngModel)]="itemQuantity"
                name="itemQuantity"
                min="1"
                step="1">
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button
                type="button"
                class="btn-primary"
                (click)="addProduct()"
                [disabled]="!selectedProductId">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 4v16m8-8H4"/>
                </svg>
                Agregar
              </button>
            </div>
          </div>
        </div>

        <!-- Products Table -->
        <div class="products-table-container" *ngIf="invoiceForm.items.length > 0">
          <table class="products-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unit.</th>
                <th>Descuento (%)</th>
                <th>IVA (%)</th>
                <th>Total</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of invoiceForm.items; let i = index" class="product-row">
                <td class="product-info">
                  <div class="product-name">{{ item.product.name }}</div>
                  <div class="product-code">{{ item.product.mainCode }}</div>
                </td>
                <td>
                  <input
                    type="number"
                    class="quantity-input"
                    [value]="item.quantity"
                    (input)="updateItemQuantity(item, $any($event.target).value)"
                    min="1"
                    step="1">
                </td>
                <td>{{ formatCurrency(item.unitPrice) }}</td>
                <td>
                  <input
                    type="number"
                    class="discount-input"
                    [value]="item.discount"
                    (input)="updateItemDiscount(item, $any($event.target).value)"
                    min="0"
                    max="100"
                    step="0.1">
                </td>
                <td>{{ item.vat }}%</td>
                <td class="total-cell">{{ formatCurrency(item.total) }}</td>
                <td>
                  <button
                    type="button"
                    class="btn-icon delete-btn"
                    (click)="removeItem(i)"
                    title="Eliminar">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Empty Products State -->
        <div *ngIf="invoiceForm.items.length === 0" class="empty-products">
          <svg width="48" height="48" fill="currentColor" viewBox="0 0 20 20" class="empty-icon">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
          </svg>
          <h4>No hay productos agregados</h4>
          <p>Seleccione un producto de la lista para comenzar a agregar items a la factura.</p>
        </div>
      </div>

      <!-- Totals Section -->
      <div class="form-section" *ngIf="invoiceForm.items.length > 0">
        <h3>Resumen de Totales</h3>
        <div class="totals-section">
          <div class="total-row">
            <span>Subtotal:</span>
            <span>{{ formatCurrency(invoiceForm.subtotal) }}</span>
          </div>
          <div class="total-row">
            <span>Descuentos:</span>
            <span>-{{ formatCurrency(invoiceForm.totalDiscount) }}</span>
          </div>
          <div class="total-row">
            <span>IVA:</span>
            <span>{{ formatCurrency(invoiceForm.totalVat) }}</span>
          </div>
          <div class="total-row total">
            <span>Total:</span>
            <span>{{ formatCurrency(invoiceForm.total) }}</span>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="cancel()">Cancelar</button>
        <button
          type="button"
          class="btn-primary"
          (click)="saveInvoice()"
          [disabled]="!isFormValid()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Crear Factura
        </button>
      </div>
    </form>
  </div>
</div>