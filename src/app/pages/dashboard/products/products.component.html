<div class="products-container">
  <!-- Loader removed: use ui-table's skeleton while loading -->
  <!-- Intro card (matches clients visual style). Action button projected via #introAction template -->
  <ng-template #introAction>
    <app-button variant="primary" size="md" (click)="openProductModal()">
      <span class="app-button__icon-html"><i class="fas fa-plus"></i></span>
      Nuevo Producto
    </app-button>
  </ng-template>

  <ui-page-intro
    [title]="'Gestión de Productos'"
    [description]="'Administra tu catálogo de productos y servicios'"
    [iconClass]="'fas fa-boxes'"
    [actionTemplate]="introAction">
  </ui-page-intro>

  <!-- Stats Cards -->
    <div class="stats-grid">
  <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-boxes&quot;&gt;&lt;/i&gt;'" title="Total Productos" [value]="products.length" variant="primary"></ui-stat-card>
  <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-dollar-sign&quot;&gt;&lt;/i&gt;'" title="Valor Total" [value]="totalValue | money:'USD':'en-US'" variant="success"></ui-stat-card>
    </div>

  <!-- Filters and Search (mirrors Clients layout) -->
  <ui-filters-panel>
    <div class="filter-selects">
      <div class="filter-field">
        <label class="filter-label">Nombre</label>
        <div class="filter-field-row">
          <app-input
            type="text"
            placeholder="Buscar por nombre..."
            [(ngModel)]="filterName"
            (input)="filterProducts()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-box"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field">
        <!-- Group: Código Principal + Código Auxiliar together -->
        <div class="filter-field-row">
          <div style="flex:1 1 50%; min-width:0; display:flex; flex-direction:column; gap:0.375rem;">
            <label class="filter-label">Código Principal</label>
            <app-input
              placeholder="Ej: PROD-001"
              type="text"
              [(ngModel)]="filterMainCode"
              (input)="filterProducts()"
              rightIcon="true">
            </app-input>
          </div>

          <div style="flex:1 1 50%; min-width:0; display:flex; flex-direction:column; gap:0.375rem;">
            <label class="filter-label">Código Auxiliar</label>
            <app-input
              placeholder="Ej: 12345"
              type="text"
              [(ngModel)]="filterAuxiliaryCode"
              (input)="filterProducts()"
              rightIcon="true">
            </app-input>
          </div>
        </div>
      </div>

      <!-- Clear filters button aligned with inputs: include a hidden label to keep baseline alignment -->
      <div class="filter-field filter-field-button">
        <label class="filter-label" aria-hidden="true" style="visibility:hidden">Limpiar</label>
        <div class="filter-field-row">
          <app-button
            variant="outline"
            size="md"
            (click)="clearProductFilters()"
            title="Limpiar todos los filtros"
            class="clear-filters-btn">
            <span class="app-button__icon-html"><i class="fas fa-broom"></i></span>
            Limpiar
          </app-button>
        </div>
      </div>
    </div>
    <div class="filter-buttons">
      <!-- reserved for additional controls if needed -->
    </div>
  </ui-filters-panel>

  <!-- Products Table (use shared ui-table for consistent standard) -->
  <div class="table-container">
    <div class="table-wrapper" *ngIf="isLoading || paginatedProducts.length > 0">
      <ng-template #actions let-product>
        <div class="action-buttons">
          <app-button
            class="edit-btn btn-icon"
            variant="ghost"
            size="sm"
            (click)="editProduct(product)"
            title="Editar"
            aria-label="Editar producto"
          >
            <span class="app-button__icon-html" aria-hidden="true"><i class="fas fa-edit"></i></span>
            <span class="sr-only">Editar</span>
          </app-button>

          <app-button
            class="delete-btn btn-icon"
            variant="ghost"
            size="sm"
            (click)="deleteProduct(product)"
            title="Eliminar"
            aria-label="Eliminar producto"
          >
            <span class="app-button__icon-html" aria-hidden="true"><i class="fas fa-trash"></i></span>
            <span class="sr-only">Eliminar</span>
          </app-button>
        </div>
      </ng-template>

      <ui-table
    [columns]="[
      { field: 'mainCode', label: 'Código Principal', width: '130px' },
      { field: 'auxiliaryCode', label: 'Código Auxiliar', width: '110px' },
      { field: 'name', label: 'Nombre' },
      { field: 'description', label: 'Descripción' },
      { field: 'unitPrice', label: 'Precio Unitario', width: '110px', align: 'right' },
      { field: 'quantity', label: 'Cantidad', width: '90px', align: 'center' },
      { field: 'discount', label: 'Descuento', width: '100px', align: 'right' },
      { field: 'vat', label: 'IVA (%)', width: '80px', align: 'center' },
      { field: 'status', label: 'Estado', width: '110px', align: 'center' }
    ]"
        [data]="paginatedProducts"
        [loading]="isLoading"
        [actionsTemplate]="actions"
      ></ui-table>
    </div>
    
    <!-- Empty State: show a full-width friendly card when there are no products and not loading -->
    <div *ngIf="!isLoading && totalElements === 0" class="empty-state">
      <div class="empty-icon" aria-hidden="true"><i class="fas fa-box-open"></i></div>
      <h3>No se encontraron productos</h3>
      <p>Intenta ajustar los filtros de búsqueda o crea un nuevo producto.</p>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="totalPages > 1">
    <div class="pagination-info">
      Mostrando {{ (currentPage - 1) * itemsPerPage + 1 }} - {{ Math.min(currentPage * itemsPerPage, totalElements) }} de {{ totalElements }} productos
    </div>

    <div class="pagination-controls">
      <button
        class="pagination-btn"
        [disabled]="currentPage === 1"
        (click)="goToPage(1)"
        title="Primera página"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z"/>
        </svg>
      </button>

      <button
        class="pagination-btn"
        [disabled]="currentPage === 1"
        (click)="previousPage()"
        title="Página anterior"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/>
        </svg>
      </button>

      <div class="pagination-numbers">
        <button
          *ngFor="let page of getPageNumbers()"
          class="pagination-number"
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
        >
          {{ page }}
        </button>
      </div>

      <button
        class="pagination-btn"
        [disabled]="currentPage === totalPages"
        (click)="nextPage()"
        title="Página siguiente"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/>
        </svg>
      </button>

      <button
        class="pagination-btn"
        [disabled]="currentPage === totalPages"
        (click)="goToPage(totalPages)"
        title="Última página"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal-overlay" *ngIf="showProductModal" (click)="closeProductModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditing ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
        <button class="close-btn" (click)="closeProductModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>

  <form class="product-form" (ngSubmit)="saveProduct()" #productForm="ngForm">
        <div class="form-row">
          <div class="form-group full-width">
            <app-input
              class="control-size"
              [(ngModel)]="currentProduct.name"
              name="name"
              id="name"
              label="Nombre *"
              placeholder="Ej: Computadora Lenovo"
              required
            ></app-input>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <app-input
              class="control-size"
              [(ngModel)]="currentProduct.mainCode"
              name="mainCode"
              id="mainCode"
              label="Código Principal *"
              placeholder="Ej: PROD-001"
              required
            ></app-input>
          </div>

          <div class="form-group">
            <app-input
              class="control-size"
              [(ngModel)]="currentProduct.auxiliaryCode"
              name="auxiliaryCode"
              id="auxiliaryCode"
              label="Código Auxiliar"
              placeholder="Ej: 12345"
            ></app-input>
          </div>
        </div>
        <div class="form-group">
          <app-input
            class="control-size"
            type="textarea"
            [(ngModel)]="currentProduct.description"
            name="description"
            id="description"
            label="Descripción *"
            placeholder="Describe el producto o servicio..."
            required
          ></app-input>
        </div>
        <div class="form-row">
          <div class="form-group">
            <app-input
              class="control-size"
              leftIcon="true"
              type="number"
              [(ngModel)]="currentProduct.unitPrice"
              name="unitPrice"
              id="unitPrice"
              label="Precio Unitario *"
              placeholder="0.00"
              required
              (inputChange)="onPriceChange()"
            >
              <span slot="left-icon">$</span>
            </app-input>
          </div>
          <div class="form-group">
            <app-input
              class="control-size"
              type="number"
              [(ngModel)]="currentProduct.quantity"
              name="quantity"
              id="quantity"
              label="Cantidad *"
              placeholder="1"
              required
              (inputChange)="onQuantityChange()"
            ></app-input>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <app-input
              class="control-size"
              leftIcon="true"
              type="number"
              [(ngModel)]="currentProduct.discount"
              name="discount"
              id="discount"
              label="Descuento"
              placeholder="0.00"
              (inputChange)="onDiscountChange()"
            >
              <span slot="left-icon">$</span>
            </app-input>
          </div>
          <div class="form-group">
            <app-input
              class="control-size"
              type="number"
              [(ngModel)]="currentProduct.vat"
              name="vat"
              id="vat"
              label="IVA (%) *"
              placeholder="12"
              required
            ></app-input>
          </div>
        </div>
        <div class="form-group">
          <app-input
            class="control-size"
            leftIcon="true"
            type="number"
            [(ngModel)]="currentProduct.totalWithoutTax"
            name="totalWithoutTax"
            id="totalWithoutTax"
            label="Total sin Impuesto *"
            placeholder="0.00"
            readonly
          >
            <span slot="left-icon">$</span>
          </app-input>
        </div>
        <div class="form-actions">
          <app-button variant="secondary" size="md" type="button" (click)="closeProductModal()">
            Cancelar
          </app-button>
          <app-button variant="primary" size="md" type="submit" [disabled]="!productForm.valid">
            {{ isEditing ? 'Actualizar' : 'Crear' }} Producto
          </app-button>
        </div>
      </form>
    </div>
  </div>
</div>
