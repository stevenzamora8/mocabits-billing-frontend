<div class="products-container">
  <ng-template #introAction>
      <a class="btn-secondary" [routerLink]="['/dashboard','products']" [title]="isEditMode ? 'Volver a la lista de productos' : 'Volver a la lista'">
          <span class="app-button__icon-html"><i class="fas fa-arrow-left"></i></span>
          Volver a la lista
      </a>
  </ng-template>

  <ui-page-intro [title]="isEditMode ? 'Editar Producto' : 'Crear Producto'"
      [description]="isEditMode ? 'Modifica los datos del producto. Los campos obligatorios están marcados.' : 'Llena los datos básicos del producto. Los campos obligatorios están marcados.'"
      [iconClass]="'fas fa-boxes'" [actionTemplate]="introAction">
  </ui-page-intro>

  <div class="table-container">
      <div class="form-wrapper">
            <ui-alert *ngIf="alertVisible" [fixed]="true" [message]="alertMessage" [type]="alertType"
                [dismissible]="true" [autoDismiss]="alertAutoDismiss" [duration]="alertAutoDismissTime"
                (closed)="alertVisible = false"></ui-alert>

            <div *ngIf="isLoading" class="loading-container">
                <p>Cargando producto...</p>
            </div>

            <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="product-form" [class.disabled]="isLoading">
                <div class="form-row">
                    <div class="form-group full-width">
                        <app-input formControlName="name" label="Nombre" placeholder="Ej: Computadora Lenovo" required
                            [errorMessage]="productForm.get('name')?.touched ? (productForm.get('name')?.hasError('required') ? 'El campo nombre es requerido' : (productForm.get('name')?.hasError('maxlength') ? 'Máximo 255 caracteres' : null)) : null"
                            rightIcon="true">
                            <i slot="right-icon" class="fas fa-box"></i>
                        </app-input>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <app-input formControlName="mainCode" label="Código Principal" placeholder="Ej: PROD-001" required
                                                        [errorMessage]="productForm.get('mainCode')?.touched ? (productForm.get('mainCode')?.hasError('required') ? 'El campo código principal es requerido' : (productForm.get('mainCode')?.hasError('maxlength') ? 'Máximo 50 caracteres' : (productForm.get('mainCode')?.hasError('mainCodeExists') ? 'El código principal ya existe' : null))) : null"
                                                        rightIcon="true">
                            <i slot="right-icon" class="fas fa-barcode"></i>
                        </app-input>
                        
                    </div>

                    <div class="form-group">
                        <app-input formControlName="auxiliaryCode" label="Código Auxiliar" placeholder="Ej: 12345" required
                                                        [errorMessage]="productForm.get('auxiliaryCode')?.touched ? (productForm.get('auxiliaryCode')?.hasError('required') ? 'El campo código auxiliar es requerido' : (productForm.get('auxiliaryCode')?.hasError('maxlength') ? 'Máximo 50 caracteres' : (productForm.get('auxiliaryCode')?.hasError('auxiliaryCodeExists') ? 'El código auxiliar ya existe' : null))) : null"
                                                        rightIcon="true">
                            <i slot="right-icon" class="fas fa-barcode"></i>
                        </app-input>
                        
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                                                <app-select formControlName="establishmentId" [options]="establishmentOptions" [loading]="loadingEstablishments" label="Establecimiento" placeholder="Seleccionar establecimiento"
                                                    [errorMessage]="productForm.get('establishmentId')?.touched ? (productForm.get('establishmentId')?.hasError('establishmentNotFound') ? 'El campo establecimiento es inválido' : null) : null"></app-select>
                    </div>
                </div>

                <div class="form-group">
                        <app-input type="textarea" formControlName="description" label="Descripción" required
                        [errorMessage]="productForm.get('description')?.touched ? (productForm.get('description')?.hasError('required') ? 'El campo descripción es requerido' : (productForm.get('description')?.hasError('maxlength') ? 'Máximo 500 caracteres' : null)) : null"
                        placeholder="Describe el producto o servicio..." rightIcon="true">
                        <i slot="right-icon" class="fas fa-align-left"></i>
                    </app-input>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <app-input formControlName="unitPrice" type="number" label="Precio Unitario" placeholder="0.00" required
                            [errorMessage]="productForm.get('unitPrice')?.touched ? (productForm.get('unitPrice')?.hasError('required') ? 'El campo precio unitario es requerido' : (productForm.get('unitPrice')?.hasError('min') ? 'Debe ser >= 0' : (productForm.get('unitPrice')?.hasError('scaleExceeded') ? 'Máximo 2 decimales' : (productForm.get('unitPrice')?.hasError('invalidNumber') ? 'Número inválido' : null)))) : null"
                            leftIcon="true">
                            <span slot="left-icon">$</span>
                        </app-input>
                    </div>

                    <div class="form-group">
                        <app-input formControlName="quantity" type="number" label="Cantidad" placeholder="1" required
                            [errorMessage]="productForm.get('quantity')?.touched ? (productForm.get('quantity')?.hasError('required') ? 'El campo cantidad es requerido' : (productForm.get('quantity')?.hasError('min') ? 'Debe ser >= 0' : null)) : null"
                            rightIcon="true">
                            <i slot="right-icon" class="fas fa-hashtag"></i>
                        </app-input>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                                                <app-select formControlName="taxRateId" [options]="taxOptions" [loading]="loadingTaxOptions" label="IVA" placeholder="Seleccionar tasa de IVA" [required]="true"
                                                    [errorMessage]="productForm.get('taxRateId')?.touched ? (productForm.get('taxRateId')?.hasError('required') ? 'El campo iva es requerido' : (productForm.get('taxRateId')?.hasError('notFound') ? 'Tasa de IVA inválida' : null)) : null"></app-select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <app-input formControlName="subtotal" type="number" label="Subtotal" placeholder="0.00" [readonly]="true" leftIcon="true">
                            <span slot="left-icon">$</span>
                        </app-input>
                    </div>
                    <div class="form-group">
                        <app-input formControlName="taxAmount" type="number" label="IVA (monto)" placeholder="0.00" [readonly]="true" leftIcon="true">
                            <span slot="left-icon">$</span>
                        </app-input>
                    </div>
                    <div class="form-group">
                        <app-input formControlName="total" type="number" label="Total" placeholder="0.00" [readonly]="true" leftIcon="true">
                            <span slot="left-icon">$</span>
                        </app-input>
                    </div>
                </div>

                <div class="form-actions">
                    <app-button variant="secondary" type="button" (click)="resetForm()">
                        <span class="app-button__icon-html"><i class="fas fa-broom"></i></span>
                        Limpiar
                    </app-button>

                    <app-button variant="primary" type="submit" [loading]="isSaving" [showIconWhenLoading]="true" [disabled]="productForm.invalid || isSaving" iconPosition="left">
                        <span class="app-button__icon-html"><i class="fas fa-save"></i></span>
                        {{ isSaving ? (isEditMode ? 'Actualizando...' : 'Guardando...') : (isEditMode ? 'Actualizar Producto' : 'Crear Producto') }}
                    </app-button>
                </div>
            </form>
      </div>
  </div>
</div>