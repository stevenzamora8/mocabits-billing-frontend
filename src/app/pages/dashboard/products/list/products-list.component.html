<div class="products-container">
  <ng-template #introAction>
    <app-button variant="primary" size="md" [routerLink]="['/dashboard/products/create']">
      <span class="app-button__icon-html"><i class="fas fa-plus"></i></span>
      Nuevo Producto
    </app-button>
  </ng-template>

  <ui-page-intro
    [title]="'Gestión de Productos'"
    [description]="'Administra tu catálogo de productos y servicios'"
    [iconClass]="'fas fa-boxes'"
    [actionTemplate]="introAction">
  </ui-page-intro>

  <!-- Alert que puede venir por navegación (p.ej. después de crear producto) -->
  <ui-alert *ngIf="alertVisible" [message]="alertMessage" [type]="alertType" [autoDismiss]="alertAutoDismiss" (closed)="alertVisible = false"></ui-alert>

  <div class="stats-grid">
    <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-boxes&quot;&gt;&lt;/i&gt;'" title="Total Productos" [value]="products.length" variant="primary"></ui-stat-card>
    <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-calculator&quot;&gt;&lt;/i&gt;'" title="Subtotal" [value]="grandSubtotal | money:'USD':'en-US'" variant="primary"></ui-stat-card>
    <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-percentage&quot;&gt;&lt;/i&gt;'" title="IVA" [value]="grandIva | money:'USD':'en-US'" variant="warning"></ui-stat-card>
    <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-dollar-sign&quot;&gt;&lt;/i&gt;'" title="Total" [value]="grandTotal | money:'USD':'en-US'" variant="success"></ui-stat-card>
  </div>

  <ui-filters-panel>
    <div class="filter-selects">
      <div class="filter-field">
        <label class="filter-label">Nombre</label>
        <div class="filter-field-row">
          <app-input type="text" placeholder="Buscar por nombre..." [(ngModel)]="filterName" (input)="filterProducts()" rightIcon="true">
            <i slot="right-icon" class="fas fa-box"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field">
        <div class="filter-field-row">
          <div style="flex:1 1 50%; min-width:0; display:flex; flex-direction:column; gap:0.375rem;">
            <label class="filter-label">Código Principal</label>
            <app-input placeholder="Ej: PROD-001" type="text" [(ngModel)]="filterMainCode" (input)="filterProducts()"></app-input>
          </div>
          <div style="flex:1 1 50%; min-width:0; display:flex; flex-direction:column; gap:0.375rem;">
            <label class="filter-label">Código Auxiliar</label>
            <app-input placeholder="Ej: 12345" type="text" [(ngModel)]="filterAuxiliaryCode" (input)="filterProducts()"></app-input>
          </div>
        </div>
      </div>

      <div class="filter-field filter-field-button">
        <label class="filter-label visually-hidden" aria-hidden="true">Limpiar</label>
        <div class="filter-field-row">
          <app-button variant="outline" size="md" (click)="clearProductFilters()" title="Limpiar todos los filtros" class="clear-filters-btn control-size">
            <span class="app-button__icon-html"><i class="fas fa-broom"></i></span>
            Limpiar
          </app-button>
        </div>
      </div>
    </div>
  </ui-filters-panel>

  <div class="table-container">
    <div class="table-wrapper" *ngIf="isLoading || filteredProducts.length > 0">
      <ng-template #actions let-product>
        <div class="action-buttons">
          <app-button class="edit-btn btn-icon" variant="ghost" size="sm" [routerLink]="['/dashboard/products', product.id, 'edit']" title="Editar">
            <span class="app-button__icon-html" aria-hidden="true"><i class="fas fa-edit"></i></span>
            <span class="sr-only">Editar</span>
          </app-button>
          <app-button class="delete-btn btn-icon" variant="ghost" size="sm" (click)="onDeleteProduct(product)" title="Eliminar">
            <span class="app-button__icon-html" aria-hidden="true"><i class="fas fa-trash"></i></span>
            <span class="sr-only">Eliminar</span>
          </app-button>
        </div>
      </ng-template>

      <ui-table
        [columns]="[
          { field: 'mainCode', label: 'Código Principal', width: '100px' },
          { field: 'auxiliaryCode', label: 'Código Auxiliar', width: '100px' },
          { field: 'name', label: 'Nombre', width: '120px' },
          { field: 'description', label: 'Descripción', width: '140px' },
          { field: 'unitPrice', label: 'Precio Unitario', width: '100px', align: 'right', pipe: 'money' },
          { field: 'quantity', label: 'Cantidad', width: '70px', align: 'center' },
          { field: 'subtotal', label: 'Subtotal', width: '90px', align: 'right', pipe: 'money' },
          { field: 'taxRateRate', label: 'IVA (%)', width: '60px', align: 'center' },
          { field: 'taxAmount', label: 'IVA', width: '80px', align: 'right', pipe: 'money' },
          { field: 'total', label: 'Total', width: '90px', align: 'right', pipe: 'money' }
        ]"
        [data]="filteredProducts"
        [loading]="isLoading"
        [actionsTemplate]="actions"
      ></ui-table>
    </div>

    <!-- Estado vacío - usando componente UI reutilizable -->
    <ui-empty-state 
      *ngIf="!isLoading && totalElements === 0"
      iconClass="fas fa-boxes"
      title="No se encontraron productos"
      description="Intenta ajustar los filtros de búsqueda o crea un nuevo producto.">
    </ui-empty-state>
  </div>

  <div class="pagination-container" *ngIf="totalPages > 1">
    <div class="pagination-info">
      Mostrando {{ (currentPage - 1) * itemsPerPage + 1 }} - {{ Math.min(currentPage * itemsPerPage, totalElements) }} de {{ totalElements }} productos
    </div>
    <div class="pagination-controls">
      <button class="pagination-btn" [disabled]="currentPage === 1" (click)="goToPage(1)" title="Primera página">«</button>
      <button class="pagination-btn" [disabled]="currentPage === 1" (click)="previousPage()" title="Página anterior">‹</button>
      <div class="pagination-numbers">
        <button *ngFor="let page of getPageNumbers()" class="pagination-number" [class.active]="page === currentPage" (click)="goToPage(page)">{{ page }}</button>
      </div>
      <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="nextPage()" title="Página siguiente">›</button>
      <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="goToPage(totalPages)" title="Última página">»</button>
    </div>
  </div>
</div>
