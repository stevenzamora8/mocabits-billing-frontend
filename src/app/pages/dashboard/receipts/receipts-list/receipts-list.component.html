<div class="receipts-list-container">
  <!-- Page intro (shared component) -->
  <ng-template #introAction>
    <app-button variant="primary" size="md" (click)="navigateToCreate()">
      <span class="app-button__icon-html"><i class="fas fa-plus"></i></span>
      Nuevo Comprobante
    </app-button>
  </ng-template>

  <ui-page-intro
    [title]="'Gestión de comprobantes'"
    [description]="'Busca, filtra y administra comprobantes. Crea, ve, edita y elimina comprobantes desde esta pantalla.'"
    [iconClass]="'fas fa-file-invoice'"
    [actionTemplate]="introAction">
  </ui-page-intro>

  <div class="stats-grid">
    <div class="stat-card primary">
      <div class="stat-icon primary">
        <i class="fas fa-file-alt"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ stats.total }}</div>
        <div class="stat-label">Total Comprobantes</div>
      </div>
    </div>

    <div class="stat-card success">
      <div class="stat-icon success">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ stats.authorized }}</div>
        <div class="stat-label">Autorizados</div>
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon warning">
        <i class="fas fa-clock"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ stats.pending }}</div>
        <div class="stat-label">Pendientes</div>
      </div>
    </div>

    <div class="stat-card danger">
      <div class="stat-icon danger">
        <i class="fas fa-times-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ stats.rejected }}</div>
        <div class="stat-label">Rechazados</div>
      </div>
    </div>
  </div>

  <div class="filters-section">
    <div class="filter-selects">
      <div class="filter-field field-name">
        <label class="filter-label">Cliente</label>
        <div class="filter-field-row">
          <app-input
            placeholder="Cliente (nombre)"
            [(ngModel)]="nameSearch"
            (input)="onSearchChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-user"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-id">
        <label class="filter-label">Identificación</label>
        <div class="filter-field-row">
          <app-input
            placeholder="Identificación cliente"
            [(ngModel)]="idSearch"
            (input)="onSearchChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-id-card"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-number">
        <label class="filter-label">Número comprobante</label>
        <div class="filter-field-row">
          <app-input
            placeholder="Número comprobante"
            [(ngModel)]="numberSearch"
            (input)="onSearchChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-file-invoice"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-start">
        <label class="filter-label">Desde</label>
        <div class="filter-field-row">
          <app-input
            type="date"
            [(ngModel)]="startDate"
            (change)="onFilterChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-calendar-alt"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-end">
        <label class="filter-label">Hasta</label>
        <div class="filter-field-row">
          <app-input
            type="date"
            [(ngModel)]="endDate"
            (change)="onFilterChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-calendar-alt"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-state">
        <label class="filter-label">Estado</label>
        <div class="filter-field-row">
          <app-select
            placeholder="Todos los estados"
            [options]="statusOptions"
            [(ngModel)]="selectedStatus"
            (selectionChange)="onFilterChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-flag"></i>
          </app-select>
        </div>
      </div>

      <div class="filter-field filter-field-button field-clear">
        <label class="filter-label" aria-hidden="true" style="visibility:hidden">Limpiar</label>
        <div class="filter-field-row">
          <app-button
            variant="outline"
            size="md"
            (click)="clearFilters()"
            title="Limpiar filtros"
            class="clear-filters-btn">
            <span class="app-button__icon-html"><i class="fas fa-broom"></i></span>
            Limpiar
          </app-button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Cargando comprobantes...</p>
  </div>

  <div *ngIf="error && !isLoading" class="error-state">
    <div class="error-icon"></div>
    <h3>Error al cargar comprobantes</h3>
    <p>{{ error }}</p>
    <button class="btn-primary" (click)="loadReceipts()">Reintentar</button>
  </div>

  <div class="table-container" *ngIf="!isLoading && !error">
    <div class="table-wrapper">
      <ng-template #actions let-row>
        <div class="action-buttons">
          <app-button variant="ghost" size="sm" (click)="viewInvoice(row)" ariaLabel="Ver" class="view-btn">
            <span class="app-button__icon-html"><i class="fas fa-eye"></i></span>
          </app-button>
          <app-button variant="ghost" size="sm" (click)="editInvoice(row)" ariaLabel="Editar" class="edit-btn">
            <span class="app-button__icon-html"><i class="fas fa-edit"></i></span>
          </app-button>
          <app-button variant="ghost" size="sm" (click)="updateStatus(row)" ariaLabel="Estado" class="status-btn">
            <span class="app-button__icon-html"><i class="fas fa-sync-alt"></i></span>
          </app-button>
          <app-button variant="ghost" size="sm" (click)="deleteInvoice(row)" ariaLabel="Eliminar" class="delete-btn">
            <span class="app-button__icon-html"><i class="fas fa-trash"></i></span>
          </app-button>
        </div>
      </ng-template>

      <ui-table
        [columns]="[
          { field: 'invoiceNumber', label: 'Número', width: '180px' },
          { field: 'clientBusinessName', label: 'Cliente', width: '260px' },
          { field: 'clientIdentification', label: 'ID Cliente', width: '140px' },
          { field: 'issueDate', label: 'Fecha Emisión', width: '140px' },
          { field: 'total', label: 'Total', width: '120px', align: 'right' }
        ]"
        [data]="filteredInvoices"
        [loading]="isLoading"
        emptyText="No se encontraron comprobantes"
        [actionsTemplate]="actions">
      </ui-table>
    </div>

    </div>

  <!-- Pagination (shared ui-paginator) placed outside the table card so spacing and shadow are separate -->
  <ui-paginator
    [totalElements]="totalElements"
    [itemsPerPage]="pageSize"
    [currentPage]="currentPage"
    (pageChange)="goToPage($event)">
  </ui-paginator>
</div>
