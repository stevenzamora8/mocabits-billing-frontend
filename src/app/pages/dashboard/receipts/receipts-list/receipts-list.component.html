<div class="receipts-list-container">
  <!-- Page intro (shared component) -->
  <ng-template #introAction>
    <app-button variant="primary" size="md" (click)="navigateToCreate()">
      <span class="app-button__icon-html"><i class="fas fa-plus"></i></span>
      Nuevo Comprobante
    </app-button>
  </ng-template>

  <ui-page-intro
    [title]="'Gestión de comprobantes'"
    [description]="'Busca, filtra y administra comprobantes. Crea, consulta, envía por correo, emite y anula comprobantes desde esta pantalla.'"
    [iconClass]="'fas fa-file-invoice'"
    [actionTemplate]="introAction">
  </ui-page-intro>

  <div class="stats-grid">
    <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-file-alt&quot;&gt;&lt;/i&gt;'" title="Total Comprobantes" [value]="stats.total" variant="primary"></ui-stat-card>

    <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-check-circle&quot;&gt;&lt;/i&gt;'" title="Autorizados" [value]="stats.authorized" variant="success"></ui-stat-card>

    <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-clock&quot;&gt;&lt;/i&gt;'" title="Pendientes" [value]="stats.pending" variant="warning"></ui-stat-card>

    <ui-stat-card [iconHtml]="'&lt;i class=&quot;fas fa-times-circle&quot;&gt;&lt;/i&gt;'" title="Rechazados" [value]="stats.rejected" variant="danger"></ui-stat-card>
  </div>

  <div *ngIf="error" class="error-state">
    <div class="error-icon"></div>
    <h3>Error al cargar comprobantes</h3>
    <p>{{ error }}</p>
    <button class="btn-primary" (click)="loadReceipts()">Reintentar</button>
  </div>

  <ui-filters-panel>
    <div class="filter-selects">
      <div class="filter-field field-name">
        <label class="filter-label">Cliente</label>
        <div class="filter-field-row">
          <app-input
            placeholder="Cliente (nombre)"
            [(ngModel)]="nameSearch"
            (input)="onSearchChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-user"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-id">
        <label class="filter-label">Identificación</label>
        <div class="filter-field-row">
          <app-input
            placeholder="Identificación cliente"
            [(ngModel)]="idSearch"
            (input)="onSearchChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-id-card"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-number">
        <label class="filter-label">Número comprobante</label>
        <div class="filter-field-row">
          <app-input
            placeholder="Número comprobante"
            [(ngModel)]="numberSearch"
            (input)="onSearchChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-file-invoice"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-start">
        <label class="filter-label">Desde</label>
        <div class="filter-field-row">
          <app-input
            type="date"
            [(ngModel)]="startDate"
            (change)="onFilterChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-calendar-alt"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-end">
        <label class="filter-label">Hasta</label>
        <div class="filter-field-row">
          <app-input
            type="date"
            [(ngModel)]="endDate"
            (change)="onFilterChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-calendar-alt"></i>
          </app-input>
        </div>
      </div>

      <div class="filter-field field-state">
        <label class="filter-label">Estado</label>
        <div class="filter-field-row">
          <app-select
            placeholder="Todos los estados"
            [options]="statusOptions"
            [(ngModel)]="selectedStatus"
            (selectionChange)="onFilterChange()"
            rightIcon="true">
            <i slot="right-icon" class="fas fa-flag"></i>
          </app-select>
        </div>
      </div>

      <div class="filter-field filter-field-button field-clear clear-button-container">
        <label class="filter-label visually-hidden" aria-hidden="true">Limpiar</label>
        <div class="filter-field-row">
          <app-button
            variant="outline"
            size="md"
            (click)="clearFilters()"
            title="Limpiar filtros"
            class="clear-filters-btn control-size">
            <span class="app-button__icon-html"><i class="fas fa-broom"></i></span>
            Limpiar
          </app-button>
        </div>
      </div>
    </div>
  </ui-filters-panel>

  

  <div class="table-container" *ngIf="!error">
    <!-- Render table when loading OR when we have elements so the shared ui-table can show its skeleton -->
    <div class="table-wrapper" *ngIf="isLoading || totalElements > 0">
      <ng-template #actions let-row>
        <div class="action-buttons">
          <app-button variant="ghost" size="sm" (click)="viewInvoice(row)" ariaLabel="Ver" class="view-btn" title="Ver comprobante">
            <span class="app-button__icon-html"><i class="fas fa-eye"></i></span>
          </app-button>

          <!-- Edit disabled for comprobantes: editing not allowed -->

          <!-- Send email -->
          <app-button variant="ghost" size="sm" (click)="sendEmail(row)" ariaLabel="Enviar correo" class="email-btn" title="Enviar por correo">
            <span class="app-button__icon-html"><i class="fas fa-envelope"></i></span>
          </app-button>

          <!-- Download PDF -->
          <app-button variant="ghost" size="sm" (click)="downloadPdf(row)" ariaLabel="Descargar PDF" class="pdf-btn" title="Descargar PDF">
            <span class="app-button__icon-html"><i class="fas fa-file-pdf"></i></span>
          </app-button>

          <!-- Download XML -->
          <app-button variant="ghost" size="sm" (click)="downloadXml(row)" ariaLabel="Descargar XML" class="xml-btn" title="Descargar XML">
            <span class="app-button__icon-html"><i class="fas fa-file-code"></i></span>
          </app-button>

          <!-- Anular (void) -->
          <app-button variant="ghost" size="sm" (click)="voidReceipt(row)" ariaLabel="Anular" class="void-btn" title="Anular comprobante">
            <span class="app-button__icon-html"><i class="fas fa-ban"></i></span>
          </app-button>

          <app-button variant="ghost" size="sm" (click)="updateStatus(row)" ariaLabel="Estado" class="status-btn" title="Actualizar estado">
            <span class="app-button__icon-html"><i class="fas fa-sync-alt"></i></span>
          </app-button>

          <!-- Delete disabled for comprobantes: deletion not allowed -->
        </div>
      </ng-template>

      <ui-table
        [columns]="[
          { field: 'invoiceNumber', label: 'Número', width: '160px' },
          { field: 'clientBusinessName', label: 'Cliente', width: '260px' },
          { field: 'clientIdentification', label: 'ID Cliente', width: '140px' },
          { field: 'issueDateDisplay', label: 'Fecha Emisión', width: '160px' },
          { field: 'totalDisplay', label: 'Total', width: '120px', align: 'right' }
        ]"
        [data]="filteredInvoices"
        [loading]="isLoading"
        emptyText="No se encontraron comprobantes"
        [actionsTemplate]="actions">
      </ui-table>
      </div>

    <!-- Empty State: show when not loading and there are no elements -->
    <div *ngIf="!isLoading && totalElements === 0" class="empty-state">
      <div class="empty-icon" aria-hidden="true"><i class="fas fa-file-invoice"></i></div>
      <h3>No se encontraron comprobantes</h3>
      <p>Intenta ajustar los filtros de búsqueda o crea un nuevo comprobante.</p>
    </div>
    </div>

  <!-- Pagination (shared ui-paginator) placed outside the table card so spacing and shadow are separate -->
  <ui-paginator
    [totalElements]="totalElements"
    [itemsPerPage]="pageSize"
    [currentPage]="currentPage"
    (pageChange)="goToPage($event)">
  </ui-paginator>
</div>
