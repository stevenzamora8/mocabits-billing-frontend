<div class="setup-container">
  <!-- Header -->
  <div class="setup-header">
    <div class="logo-section">
      <div class="logo-placeholder">
        <i class="icon-building"></i>
      </div>
      <div class="header-text">
        <h1>Configuración Inicial</h1>
        <p>Configure su empresa para comenzar a facturar</p>
      </div>
    </div>
    <div class="header-actions">
      <button 
        type="button" 
        class="btn-logout" 
        (click)="logout()"
        title="Cerrar Sesión">
        <i class="icon-logout"></i>
        <span>Cerrar Sesión</span>
      </button>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>
    <div class="step-indicators">
      <div class="step-indicator" 
           [class.active]="currentStep >= 1" 
           [class.completed]="currentStep > 1">
        <span class="step-number">1</span>
        <span class="step-label">Contribuyente</span>
      </div>
      <div class="step-indicator" 
           [class.active]="currentStep >= 2" 
           [class.completed]="currentStep > 2">
        <span class="step-number">2</span>
        <span class="step-label">Establecimientos</span>
      </div>
      <div class="step-indicator" 
           [class.active]="currentStep >= 3" 
           [class.completed]="currentStep > 3">
        <span class="step-number">3</span>
        <span class="step-label">Firma & Logo</span>
      </div>
    </div>
  </div>

  <!-- Step Content -->
  <div class="step-content">
    <div class="step-header">
      <h2>{{ getStepTitle() }}</h2>
      <p class="step-description">{{ getStepDescription() }}</p>
    </div>

    <!-- Step 1: Datos del Contribuyente -->
    <div *ngIf="currentStep === 1" class="step-form">
      <form [formGroup]="companyForm" class="company-form">
        
        <div class="form-section">
          <h3><i class="icon-document"></i> Información Tributaria</h3>
          
          <div class="form-row">
            <div class="form-group full-width">
              <label for="razonSocial">Razón Social *</label>
              <input 
                type="text" 
                id="razonSocial"
                formControlName="razonSocial"
                class="setup-input"
                [class.error]="isFieldInvalid(companyForm, 'razonSocial')"
                placeholder="Nombre legal de la empresa">
              <div class="error-message" *ngIf="isFieldInvalid(companyForm, 'razonSocial')">
                {{ getFieldError(companyForm, 'razonSocial') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="nombreComercial">Nombre Comercial *</label>
              <input 
                type="text" 
                id="nombreComercial"
                formControlName="nombreComercial"
                class="setup-input"
                [class.error]="isFieldInvalid(companyForm, 'nombreComercial')"
                placeholder="Nombre comercial o marca">
              <div class="error-message" *ngIf="isFieldInvalid(companyForm, 'nombreComercial')">
                {{ getFieldError(companyForm, 'nombreComercial') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half-width">
              <label for="ruc">RUC *</label>
              <div class="input-wrapper">
                <input 
                  type="text" 
                  id="ruc"
                  formControlName="ruc"
                  class="setup-input"
                  [class.error]="isFieldInvalid(companyForm, 'ruc')"
                  [class.validating]="rucValidationState === 'validating'"
                  [class.valid]="rucValidationState === 'valid'"
                  placeholder="1234567890001"
                  maxlength="13">
                <div class="validation-indicator">
                  <div *ngIf="rucValidationState === 'validating'" class="spinner-icon"></div>
                  <div *ngIf="rucValidationState === 'valid'" class="success-icon"></div>
                  <div *ngIf="rucValidationState === 'invalid'" class="error-icon"></div>
                </div>
              </div>
              <div class="error-message" *ngIf="isFieldInvalid(companyForm, 'ruc')">
                {{ getFieldError(companyForm, 'ruc') }}
              </div>
              <div class="info-message" *ngIf="rucValidationState === 'validating'">
                Verificando disponibilidad del RUC...
              </div>
            </div>

            <div class="form-group">
              <label for="codDoc">Tipo Documento *</label>
              <select 
                id="codDoc"
                formControlName="codDoc"
                class="setup-input"
                [class.error]="isFieldInvalid(companyForm, 'codDoc')">
                <option value="04">RUC</option>
                <option value="05">Cédula</option>
                <option value="06">Pasaporte</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="dirMatriz">Dirección Matriz *</label>
              <textarea 
                id="dirMatriz"
                formControlName="dirMatriz"
                class="setup-input"
                [class.error]="isFieldInvalid(companyForm, 'dirMatriz')"
                placeholder="Dirección completa de la matriz"
                rows="3"></textarea>
              <div class="error-message" *ngIf="isFieldInvalid(companyForm, 'dirMatriz')">
                {{ getFieldError(companyForm, 'dirMatriz') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="obligadoContabilidad">Obligado a llevar contabilidad *</label>
              <select 
                id="obligadoContabilidad"
                formControlName="obligadoContabilidad"
                class="setup-input">
                <option value="SI">Sí</option>
                <option value="NO">No</option>
              </select>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 2: Establecimientos -->
    <div *ngIf="currentStep === 2" class="step-form">
      <div class="establishments-header">
        <h3><i class="icon-store"></i> Puntos de Emisión</h3>
        <button type="button" class="btn-add-establishment" (click)="addNewEstablishment()">
          <i class="icon-plus"></i> Agregar Establecimiento
        </button>
      </div>

      <!-- Pestañas de Establecimientos -->
      <div class="establishments-tabs" *ngIf="establishments.length > 1">
        <div class="tab" 
             *ngFor="let est of establishments; let i = index"
             [class.active]="i === currentEstablishmentIndex"
             (click)="selectEstablishment(i)">
          <span>Establecimiento {{ est.estab }}</span>
          <button type="button" 
                  class="tab-close" 
                  (click)="removeEstablishment(i)"
                  *ngIf="establishments.length > 1">×</button>
        </div>
      </div>

      <form [formGroup]="establishmentForm" class="establishment-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-group">
              <label for="estab">Código Establecimiento *</label>
              <input 
                type="text" 
                id="estab"
                formControlName="estab"
                class="setup-input"
                [class.error]="isFieldInvalid(establishmentForm, 'estab')"
                placeholder="001"
                maxlength="3">
              <div class="error-message" *ngIf="isFieldInvalid(establishmentForm, 'estab')">
                {{ getFieldError(establishmentForm, 'estab') }}
              </div>
            </div>

            <div class="form-group">
              <label for="ptoEmi">Punto Emisión *</label>
              <input 
                type="text" 
                id="ptoEmi"
                formControlName="ptoEmi"
                class="setup-input"
                [class.error]="isFieldInvalid(establishmentForm, 'ptoEmi')"
                placeholder="001"
                maxlength="3">
              <div class="error-message" *ngIf="isFieldInvalid(establishmentForm, 'ptoEmi')">
                {{ getFieldError(establishmentForm, 'ptoEmi') }}
              </div>
            </div>

            <div class="form-group">
              <label for="secuencial">Secuencial Inicial *</label>
              <input 
                type="text" 
                id="secuencial"
                formControlName="secuencial"
                class="setup-input"
                [class.error]="isFieldInvalid(establishmentForm, 'secuencial')"
                placeholder="000000001"
                maxlength="9">
              <div class="error-message" *ngIf="isFieldInvalid(establishmentForm, 'secuencial')">
                {{ getFieldError(establishmentForm, 'secuencial') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="dirEstablecimiento">Dirección del Establecimiento *</label>
              <textarea 
                id="dirEstablecimiento"
                formControlName="dirEstablecimiento"
                class="setup-input"
                [class.error]="isFieldInvalid(establishmentForm, 'dirEstablecimiento')"
                placeholder="Dirección completa del punto de emisión"
                rows="3"></textarea>
              <div class="error-message" *ngIf="isFieldInvalid(establishmentForm, 'dirEstablecimiento')">
                {{ getFieldError(establishmentForm, 'dirEstablecimiento') }}
              </div>
            </div>
          </div>
        </div>
      </form>

      <!-- Resumen de Establecimientos -->
      <div class="establishments-summary" *ngIf="establishments.length > 0">
        <h4>Resumen de Establecimientos</h4>
        <div class="summary-cards">
          <div class="summary-card" 
               *ngFor="let est of establishments; let i = index"
               [class.current]="i === currentEstablishmentIndex">
            <div class="card-header">
              <strong>{{ est.estab }}-{{ est.ptoEmi }}</strong>
              <span class="sequence">Sec: {{ est.secuencial }}</span>
            </div>
            <div class="card-address">{{ est.dirEstablecimiento || 'Sin dirección' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Firma Electrónica y Logo -->
    <div *ngIf="currentStep === 3" class="step-form">
      
      <!-- Sección Firma Electrónica -->
      <div class="form-section">
        <h3><i class="icon-certificate"></i> Certificado de Firma Electrónica</h3>
        
        <div class="signature-upload">
          <div class="upload-area" [class.has-file]="signatureFile" [class.error]="getSignatureError()">
            <input 
              type="file" 
              id="signature"
              accept=".p12,.pfx"
              (change)="onSignatureChange($event)"
              class="file-input"
              hidden>
            
            <label for="signature" class="upload-label">
              <div class="upload-icon" *ngIf="!signatureFile">
                <i class="icon-upload"></i>
              </div>
              <div class="upload-icon success" *ngIf="signatureFile && !getSignatureError()">
                <i class="icon-check"></i>
              </div>
              
              <div class="upload-text">
                <span class="upload-title" *ngIf="!signatureFile">
                  Seleccionar Certificado (.p12 o .pfx)
                </span>
                <span class="upload-title success" *ngIf="signatureFile && !getSignatureError()">
                  {{ signatureFile.name }}
                </span>
                <span class="upload-subtitle" *ngIf="!signatureFile">
                  Máximo 5MB • Formatos: .p12, .pfx
                </span>
                <span class="upload-subtitle" *ngIf="signatureFile && !getSignatureError()">
                  {{ formatFileSize(signatureFile.size) }} • ✓ Válido
                </span>
              </div>
            </label>
          </div>
          
          <div class="error-message" *ngIf="getSignatureError()">
            {{ getSignatureError() }}
          </div>
        </div>

        <div class="form-group" *ngIf="signatureFile">
          <label for="signaturePassword">Contraseña del Certificado *</label>
          <input 
            type="password" 
            id="signaturePassword"
            [(ngModel)]="signaturePassword"
            class="setup-input"
            placeholder="Ingrese la contraseña del certificado"
            required>
          <div class="input-help">
            La contraseña que utilizó al generar el certificado de firma electrónica
          </div>
        </div>
      </div>

      <!-- Sección Logo Empresarial -->
      <div class="form-section">
        <h3><i class="icon-image"></i> Logo Empresarial</h3>
        
        <div class="logo-configuration">
          <div class="logo-preview">
            <div class="preview-container">
              <div class="logo-placeholder-large" *ngIf="!logoFile || logoOption === 'temporary'">
                <i class="icon-image"></i>
                <span>Vista Previa del Logo</span>
              </div>
              <img *ngIf="logoFile && logoOption === 'custom'" 
                   [src]="getLogoPreview()" 
                   alt="Logo preview"
                   class="logo-preview-image">
            </div>
          </div>
          
          <div class="logo-upload">
            <input 
              type="file" 
              id="logo"
              accept=".png,.jpg,.jpeg,.svg"
              (change)="onLogoChange($event)"
              class="file-input"
              hidden>
            
            <label for="logo" class="btn-upload-logo">
              <i class="icon-upload"></i>
              Subir Logo
            </label>
            
            <div class="logo-requirements">
              <h4>Requerimientos del Logo:</h4>
              <ul>
                <li>Formatos: PNG, JPG, SVG</li>
                <li>Tamaño mínimo: 100x100px</li>
                <li>Fondo transparente (recomendado)</li>
                <li>Tamaño máximo: 2MB</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="logo-options">
          <div class="option-card">
            <input type="radio" 
                   id="logo-temp" 
                   name="logoOption" 
                   value="temporary" 
                   [checked]="logoOption === 'temporary'"
                   (change)="onLogoOptionChange('temporary')">
            <label for="logo-temp" class="option-label">
              <div class="option-icon">
                <i class="icon-settings"></i>
              </div>
              <div class="option-content">
                <h4>Usar Logo Temporal</h4>
                <p>Comenzar con el logo por defecto del sistema</p>
              </div>
            </label>
          </div>

          <div class="option-card">
            <input type="radio" 
                   id="logo-custom" 
                   name="logoOption" 
                   value="custom"
                   [checked]="logoOption === 'custom'"
                   (change)="onLogoOptionChange('custom')">
            <label for="logo-custom" class="option-label">
              <div class="option-icon">
                <i class="icon-image"></i>
              </div>
              <div class="option-content">
                <h4>Subir Logo Personalizado</h4>
                <p>Usar el logo de su empresa (recomendado)</p>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Información Adicional -->
      <div class="info-section">
        <div class="info-card">
          <div class="info-icon">
            <i class="icon-info"></i>
          </div>
          <div class="info-content">
            <h4>Información Importante</h4>
            <ul>
              <li>El certificado de firma electrónica es requerido para la facturación electrónica</li>
              <li>Debe ser emitido por una entidad certificadora autorizada (BCE, ANF, etc.)</li>
              <li>El logo puede cambiarse posteriormente en la configuración</li>
              <li>Todos los datos pueden ser modificados después del setup inicial</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="navigation-buttons">
    <button 
      type="button" 
      class="btn-secondary" 
      (click)="prevStep()"
      *ngIf="currentStep > 1"
      [disabled]="isLoading">
      <i class="icon-arrow-left"></i>
      Anterior
    </button>

    <button 
      type="button" 
      class="btn-primary" 
      (click)="nextStep()"
      *ngIf="currentStep < totalSteps"
      [disabled]="!canContinue()">
      Continuar
      <i class="icon-arrow-right"></i>
    </button>

    <button 
      type="button" 
      class="btn-success" 
      (click)="finishSetup()"
      *ngIf="currentStep === totalSteps"
      [disabled]="!canFinish() || isLoading">
      <span *ngIf="!isLoading">
        <i class="icon-check"></i>
        Cargar
      </span>
      <span *ngIf="isLoading">
        <i class="icon-loading"></i>
        Cargando...
      </span>
    </button>
  </div>

  <!-- Alert Component -->
  <app-alert
    [message]="alertMessage"
    [type]="alertType"
    confirmTitle="Confirmar Acción"
    confirmText="Confirmar"
    cancelText="Cancelar"
    (confirmed)="onAlertConfirmed()"
    (cancelled)="onAlertCancelled()"
    (closed)="clearAlert()">
  </app-alert>
</div>
