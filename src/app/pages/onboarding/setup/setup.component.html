
<div class="setup-container">

  <!-- Intro Section -->
  <div class="setup-header">
    <div class="logo-section">
      <div class="logo-placeholder">
        <i class="icon-building"></i>
      </div>
      <div class="header-text">
        <h1>Configuración Inicial</h1>
        <p>Bienvenido al asistente de configuración. Complete los siguientes pasos para dejar lista su empresa y comenzar a facturar en minutos.</p>
      </div>
    </div>
    <div class="header-actions">
      <app-button
        variant="ghost"
        size="sm"
        (click)="logout()"
        title="Cerrar Sesión">
        <i class="icon-logout"></i>
        <span>Cerrar Sesión</span>
      </app-button>
    </div>
  </div>

  <!-- Step Indicators (Barra de pasos) -->
  <div class="progress-container">
    <div class="step-indicators">
      <div class="step-indicator" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <span class="step-number">1</span>
        <span class="step-label">Contribuyente</span>
      </div>
      <div class="step-indicator" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <span class="step-number">2</span>
        <span class="step-label">Establecimientos</span>
      </div>
      <div class="step-indicator" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
        <span class="step-number">3</span>
        <span class="step-label">Firma & Logo</span>
      </div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>
  </div>

  <!-- Step Content -->
  <div class="step-content">
    <div class="step-header">
      <h2>{{ getStepTitle() }}</h2>
      <p class="step-description">{{ getStepDescription() }}</p>
    </div>

    <!-- Step 1: Datos del Contribuyente -->
    <div *ngIf="currentStep === 1" class="step-form">
      <form [formGroup]="companyForm" class="company-form">
        
        <div class="form-section">
          <h3><i class="icon-document"></i> Información Tributaria</h3>
          <div class="form-row">
            <div class="form-group full-width">
              <app-input
                formControlName="razonSocial"
                label="Razón Social"
                placeholder="Nombre legal de la empresa"
                [required]="true"
                rightIcon="building"
                [errorMessage]="getFieldError(companyForm, 'razonSocial')">
                <svg slot="right-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
                </svg>
              </app-input>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <app-input
                formControlName="nombreComercial"
                label="Nombre Comercial"
                placeholder="Nombre comercial o marca"
                [required]="true"
                rightIcon="shop"
                [errorMessage]="getFieldError(companyForm, 'nombreComercial')">
                <svg slot="right-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/>
                </svg>
              </app-input>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group half-width">
              <app-input
                formControlName="ruc"
                label="RUC"
                placeholder="1234567890001"
                [required]="true"
                [maxLength]="13"
                [loading]="rucValidationState === 'validating'"
                [state]="rucValidationState === 'valid' ? 'success' : (rucValidationState === 'invalid' ? 'error' : 'default')"
                [errorMessage]="getFieldError(companyForm, 'ruc')"
                rightIcon="id"
                [hint]="rucValidationState === 'validating' ? 'Verificando disponibilidad del RUC...' : ''">
                <svg slot="right-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                </svg>
              </app-input>
            </div>
            <div class="form-group half-width">
              <app-select
                formControlName="obligadoContabilidad"
                label="Obligado a llevar contabilidad"
                [options]="accountingObligationOptions"
                [required]="true">
                <svg slot="right-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                </svg>
              </app-select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <app-input
                formControlName="dirMatriz"
                label="Dirección Matriz"
                type="textarea"
                placeholder="Dirección completa de la matriz"
                [required]="true"
                [rows]="3"
                rightIcon="map"
                [errorMessage]="getFieldError(companyForm, 'dirMatriz')">
                <svg slot="right-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
              </app-input>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 2: Establecimientos -->
    <div *ngIf="currentStep === 2" class="step-form">
      <div class="establishments-header">
        <h3><i class="icon-store"></i> Puntos de Emisión</h3>
        <app-button
          variant="outline"
          size="sm"
          (click)="addNewEstablishment()">
          <i class="icon-plus"></i> Agregar Establecimiento
        </app-button>
      </div>

      <!-- Pestañas de Establecimientos -->
      <div class="establishments-tabs" *ngIf="establishments.length > 1">
        <div class="tab" 
             *ngFor="let est of establishments; let i = index"
             [class.active]="i === currentEstablishmentIndex"
             (click)="selectEstablishment(i)">
          <span>Establecimiento {{ est.estab }}</span>
          <button type="button" 
                  class="tab-close" 
                  (click)="removeEstablishment(i)"
                  *ngIf="establishments.length > 1">×</button>
        </div>
      </div>

      <form [formGroup]="establishmentForm" class="establishment-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-group">
              <app-input
                formControlName="estab"
                label="Código Establecimiento"
                placeholder="001"
                [required]="true"
                [maxLength]="3"
                rightIcon="store"
                [errorMessage]="getFieldError(establishmentForm, 'estab')">
                <svg slot="right-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/>
                </svg>
              </app-input>
            </div>

            <div class="form-group">
              <app-input
                formControlName="ptoEmi"
                label="Punto Emisión"
                placeholder="001"
                [required]="true"
                [maxLength]="3"
                rightIcon="printer"
                [errorMessage]="getFieldError(establishmentForm, 'ptoEmi')">
                <svg slot="right-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                </svg>
              </app-input>
            </div>

            <div class="form-group">
              <app-input
                formControlName="secuencial"
                label="Secuencial Inicial"
                placeholder="000000001"
                [required]="true"
                [maxLength]="9"
                rightIcon="hash"
                [errorMessage]="getFieldError(establishmentForm, 'secuencial')">
                <svg slot="right-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11.4 10.5h1.2v3h-1.2zm0-3.3h1.2v1.2h-1.2zM21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.9 13.2h-1.2v1.2h-1.2v-1.2h-3v-1.2l3-4.5h1.2v4.5h1.2zm-6.3-9.9h2.4v1.2h-2.4v3h-1.2v-3H8.2V6.3h2.4V3h1.2z"/>
                </svg>
              </app-input>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <app-input
                formControlName="dirEstablecimiento"
                label="Dirección del Establecimiento"
                type="textarea"
                placeholder="Dirección completa del punto de emisión"
                [required]="true"
                [rows]="3"
                rightIcon="map"
                [errorMessage]="getFieldError(establishmentForm, 'dirEstablecimiento')">
                <svg slot="right-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
              </app-input>
            </div>
          </div>
        </div>
      </form>

      <!-- Resumen de Establecimientos -->
      <div class="establishments-summary" *ngIf="establishments.length > 0">
        <h4>Resumen de Establecimientos</h4>
        <div class="summary-cards">
          <div class="summary-card" 
               *ngFor="let est of establishments; let i = index"
               [class.current]="i === currentEstablishmentIndex">
            <div class="card-header">
              <strong>{{ est.estab }}-{{ est.ptoEmi }}</strong>
              <span class="sequence">Sec: {{ est.secuencial }}</span>
            </div>
            <div class="card-address">{{ est.dirEstablecimiento || 'Sin dirección' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Firma Electrónica y Logo -->
    <div *ngIf="currentStep === 3" class="step-form">
      
      <!-- Sección Firma Electrónica -->
      <div class="form-section">
        <h3><i class="icon-certificate"></i> Certificado de Firma Electrónica</h3>
        
        <div class="signature-upload">
          <div class="upload-area" [class.has-file]="signatureFile" [class.error]="getSignatureError()">
            <input 
              type="file" 
              id="signature"
              accept=".p12,.pfx"
              (change)="onSignatureChange($event)"
              class="file-input"
              hidden>
            
            <label for="signature" class="upload-label">
              <div class="upload-icon" *ngIf="!signatureFile">
                <i class="icon-upload"></i>
              </div>
              <div class="upload-icon success" *ngIf="signatureFile && !getSignatureError()">
                <i class="icon-check"></i>
              </div>
              
              <div class="upload-text">
                <span class="upload-title" *ngIf="!signatureFile">
                  Seleccionar Certificado (.p12 o .pfx)
                </span>
                <span class="upload-title success" *ngIf="signatureFile && !getSignatureError()">
                  {{ signatureFile.name }}
                </span>
                <span class="upload-subtitle" *ngIf="!signatureFile">
                  Máximo 5MB • Formatos: .p12, .pfx
                </span>
                <span class="upload-subtitle" *ngIf="signatureFile && !getSignatureError()">
                  {{ formatFileSize(signatureFile.size) }} • ✓ Válido
                </span>
              </div>
            </label>
          </div>
          
          <div class="error-message" *ngIf="getSignatureError()">
            {{ getSignatureError() }}
          </div>
        </div>

        <div class="form-group" *ngIf="signatureFile">
          <label for="signaturePassword">Contraseña del Certificado *</label>
          <input 
            type="password" 
            id="signaturePassword"
            [(ngModel)]="signaturePassword"
            class="setup-input"
            placeholder="Ingrese la contraseña del certificado"
            required>
          <div class="input-help">
            La contraseña que utilizó al generar el certificado de firma electrónica
          </div>
        </div>
      </div>

      <!-- Sección Logo Empresarial -->
      <div class="form-section">
        <h3><i class="icon-image"></i> Logo Empresarial</h3>
        
        <div class="logo-configuration">
          <div class="logo-preview">
            <div class="preview-container">
              <div class="logo-placeholder-large" *ngIf="!logoFile || logoOption === 'temporary'">
                <i class="icon-image"></i>
                <span>Vista Previa del Logo</span>
              </div>
              <img *ngIf="logoFile && logoOption === 'custom'" 
                   [src]="getLogoPreview()" 
                   alt="Logo preview"
                   class="logo-preview-image">
            </div>
          </div>
          
          <div class="logo-upload">
            <input 
              type="file" 
              id="logo"
              accept=".png,.jpg,.jpeg,.svg"
              (change)="onLogoChange($event)"
              class="file-input"
              hidden>
            
            <label for="logo" class="btn-upload-logo">
              <i class="icon-upload"></i>
              Subir Logo
            </label>
            
            <div class="logo-requirements">
              <h4>Requerimientos del Logo:</h4>
              <ul>
                <li>Formatos: PNG, JPG, SVG</li>
                <li>Tamaño mínimo: 100x100px</li>
                <li>Fondo transparente (recomendado)</li>
                <li>Tamaño máximo: 2MB</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="logo-options">
          <div class="option-card">
            <input type="radio" 
                   id="logo-temp" 
                   name="logoOption" 
                   value="temporary" 
                   [checked]="logoOption === 'temporary'"
                   (change)="onLogoOptionChange('temporary')">
            <label for="logo-temp" class="option-label">
              <div class="option-icon">
                <i class="icon-settings"></i>
              </div>
              <div class="option-content">
                <h4>Usar Logo Temporal</h4>
                <p>Comenzar con el logo por defecto del sistema</p>
              </div>
            </label>
          </div>

          <div class="option-card">
            <input type="radio" 
                   id="logo-custom" 
                   name="logoOption" 
                   value="custom"
                   [checked]="logoOption === 'custom'"
                   (change)="onLogoOptionChange('custom')">
            <label for="logo-custom" class="option-label">
              <div class="option-icon">
                <i class="icon-image"></i>
              </div>
              <div class="option-content">
                <h4>Subir Logo Personalizado</h4>
                <p>Usar el logo de su empresa (recomendado)</p>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Información Adicional -->
      <div class="info-section">
        <div class="info-card">
          <div class="info-icon">
            <i class="icon-info"></i>
          </div>
          <div class="info-content">
            <h4>Información Importante</h4>
            <ul>
              <li>El certificado de firma electrónica es requerido para la facturación electrónica</li>
              <li>Debe ser emitido por una entidad certificadora autorizada (BCE, ANF, etc.)</li>
              <li>El logo puede cambiarse posteriormente en la configuración</li>
              <li>Todos los datos pueden ser modificados después del setup inicial</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="navigation-buttons">
    <app-button
      *ngIf="currentStep > 1"
      variant="secondary"
      size="lg"
      [disabled]="isLoading"
      (click)="prevStep()">
      <i class="icon-arrow-left"></i>
      Anterior
    </app-button>

    <app-button
      *ngIf="currentStep < totalSteps"
      variant="primary"
      size="lg"
      [disabled]="!canContinue()"
      (click)="nextStep()">
      Continuar
      <i class="icon-arrow-right"></i>
    </app-button>

    <app-button
      *ngIf="currentStep === totalSteps"
      variant="primary"
      size="lg"
      [loading]="isLoading"
      [disabled]="!canFinish()"
      (click)="finishSetup()">
      <span *ngIf="!isLoading">
        <i class="icon-check"></i>
        Completar Setup
      </span>
    </app-button>
  </div>

  <!-- Alert Component -->
  <app-alert
    [message]="alertMessage"
    [type]="alertType"
    confirmTitle="Confirmar Acción"
    confirmText="Confirmar"
    cancelText="Cancelar"
    (confirmed)="onAlertConfirmed()"
    (cancelled)="onAlertCancelled()"
    (closed)="clearAlert()">
  </app-alert>
</div>
